# Explorer State Bug — 탐색기 is-active/has-focus 잔류 문제

## 배경: 옵시디언 탐색기 기본 동작

탐색기(File Explorer)에는 파일 항목 위에 표시되는 시각적 상태가 있다:

| 상태 | CSS 클래스 | 모양 | 발생 조건 |
|------|-----------|------|----------|
| 호버 | (CSS hover) | 회색 블록 | 마우스를 올렸을 때 |
| 활성 | `is-active` | 회색 블록 (호버와 동일한 모양) | 파일이 열려있을 때 |
| 포커스 | `has-focus` | 진회색 보더라인 | 더블클릭 등으로 포커스가 잡혔을 때 |

정상 동작:
- **싱글클릭**으로 파일 열기 → `is-active`만 생김
- **더블클릭**으로 파일 열기 → `is-active` + `has-focus` 동시에 생김
- **탭 전환** 시 → 탐색기가 현재 열린 파일을 찾아 `is-active` 표시
- **탭 닫기** 시 → 해당 파일의 `is-active`/`has-focus` 소실

## 버그 현상 (옵시디언 자체 버그, 플러그인 무관)

### 재현 절차
1. 탐색기에서 파일을 **더블클릭**으로 열기 → `is-active` + `has-focus` 발생
2. 다른 곳 클릭, 편집 등 **아무 동작 없이** 바로 탭을 닫기
3. 탐색기에 `is-active`와 `has-focus`가 **잔류**함 (소실되지 않음)
4. 이 상태에서 해당 파일을 싱글클릭하든 더블클릭하든 **아무 반응 없음** (이미 활성으로 인식)

### 임시 해결
다른 곳을 한번 클릭해서 활성 해제 후 다시 클릭하면 정상 동작함.

## 플러그인에서의 수정 시도

### 목표
탭 닫힘(`detach`) 시점에 탐색기의 잔류 상태를 정리해주기.

### 1차 시도: is-active / has-focus 직접 제거
- DOM 클래스 직접 제거 또는 `activeDom`을 직접 null로 설정하는 방식 사용
- **결과: 부분 성공** — 제거 후 클릭이 다시 먹힘

### 2차 문제 발견
1차 수정 후, 다음 시나리오에서 새로운 문제 발생:

1. 더블클릭으로 파일 열기
2. 탭 닫기 (1차 수정에 의해 is-active/has-focus 제거됨)
3. **같은 파일을 싱글클릭**으로 열기

**기대 결과:** 파일이 열리고, 탐색기에 `is-active`(회색 블록) 표시
**실제 결과:** 파일은 열리지만, 탐색기에 `is-active`가 **생기지 않음** (마우스 호버 시에만 회색 블록이 보이고, 마우스가 벗어나면 아무 표시 없음)

### 원인 추정
DOM 클래스나 내부 속성을 직접 조작하면 Obsidian 내부 상태(`activeDom`, `tree.activeDom` 등)와 불일치가 발생한다. 이로 인해 이후 파일을 열어도 탐색기가 `is-active`를 다시 씌워주지 못하게 된다.

### 다음 단계
`explorerView.onFileOpen(null)` 등 Obsidian 공식 메서드를 사용하여 내부 상태 정합성을 유지하면서 정리하는 방식으로 전환 필요.

> **핵심 원칙 (CLAUDE.md 참고):**
> - `activeDom` 직접 조작 금지 → `explorerView.onFileOpen(null)` 사용
> - 포커스 해제 → `tree.setFocusedItem(null)` 사용
> - 다중선택 해제 → `tree.clearSelectedDoms()` 사용
